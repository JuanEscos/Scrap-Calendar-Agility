name: Calendario RSCE diario

on:
  schedule:
    - cron: '5 4 * * *'
  workflow_dispatch: {}

jobs:
  run_and_upload:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Madrid

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Instalar dependencias
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Ejecutar script que genera el CSV
        shell: bash
        run: |
          set -e
          python "./Calendario RSCE 25.08.22.py"

      - name: Localizar CSV y calcular hash
        id: csv
        shell: bash
        run: |
          set -euo pipefail
          CSV_PATH="$(find . -type f -name 'eventos_agility_2025.csv' -print -quit)"
          if [ -z "$CSV_PATH" ] && [ -f "./resultados_agility/eventos_agility_2025.csv" ]; then
            CSV_PATH="./resultados_agility/eventos_agility_2025.csv"
          fi
          if [ -z "$CSV_PATH" ]; then
            echo 'No se encontró eventos_agility_2025.csv' >&2
            exit 1
          fi
          echo "csv_path=$CSV_PATH" >> "$GITHUB_OUTPUT"
          sha256sum "$CSV_PATH" | awk '{print $1}' > local.sha256

      - name: Definir rutas remotas
        id: remote
        shell: bash
        env:
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
        run: |
          set -euo pipefail
          DIR="${FTP_REMOTE_DIR:-/}"
          DIR="/${DIR#/}"; DIR="${DIR%/}"
          BASE_PATH="${DIR}/Competiciones/EventosProx/RSCE/data"
          REMOTE_FILE="${BASE_PATH}/eventos_agility_2025.csv"
          echo "base_path=${BASE_PATH}"   >> "$GITHUB_OUTPUT"
          echo "remote_file=${REMOTE_FILE}" >> "$GITHUB_OUTPUT"

      - name: Subir CSV (3 estrategias)
        shell: bash
        env:
          FTP_SERVER:   ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail
          CSV_PATH="${{ steps.csv.outputs.csv_path }}"
          REMOTE_FILE="${{ steps.remote.outputs.remote_file }};type=i"

          echo "Intento 1) FTPS explícito (21), PASV"
          if curl -v --fail --ssl-reqd \
               --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
               --ftp-method nocwd \
               --disable-epsv --ftp-skip-pasv-ip \
               --upload-file "${CSV_PATH}" \
               "ftp://${FTP_SERVER}${REMOTE_FILE}"; then
            echo "OK intento 1"
          else
            echo "Fallo intento 1, probando intento 2 (activo)…"
            if curl -v --fail --ssl-reqd \
                 --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
                 --ftp-method nocwd \
                 --ftp-port "-" \
                 --upload-file "${CSV_PATH}" \
                 "ftp://${FTP_SERVER}${REMOTE_FILE}"; then
              echo "OK intento 2"
            else
              echo "Fallo intento 2, probando intento 3 (implícito 990)…"
              curl -v --fail \
                   --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
                   --ftp-method nocwd \
                   --disable-epsv --ftp-skip-pasv-ip \
                   --upload-file "${CSV_PATH}" \
                   "ftps://${FTP_SERVER}:990${REMOTE_FILE}"
              echo "OK intento 3"
            fi
          fi

      - name: Verificar remoto (descarga y hash)
        shell: bash
        env:
          FTP_SERVER:   ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail
          REMOTE_FILE="${{ steps.remote.outputs.remote_file }};type=i"

          echo "Descarga verificación (FTPS explícito 21)…"
          if curl --fail --ssl-reqd \
               --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
               --ftp-method nocwd \
               --disable-epsv --ftp-skip-pasv-ip \
               --output remote.csv \
               "ftp://${FTP_SERVER}${REMOTE_FILE}"; then
            :
          else
            echo "Fallo verificación explícita; probando implícito 990…"
            curl --fail \
                 --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
                 --ftp-method nocwd \
                 --disable-epsv --ftp-skip-pasv-ip \
                 --output remote.csv \
                 "ftps://${FTP_SERVER}:990${REMOTE_FILE}"
          fi

          sha256sum remote.csv | awk '{print $1}' > remote.sha256
          diff -q local.sha256 remote.sha256
          echo "Hash OK"
