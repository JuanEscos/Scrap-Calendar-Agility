name: Calendario RSCE diario

on:
  schedule:
    - cron: '5 4 * * *'   # 04:05 UTC
  workflow_dispatch: {}

jobs:
  run_and_upload:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Madrid

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Instalar dependencias (si existe requirements.txt)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Ejecutar script que genera el CSV
        run: |
          python "./Calendario RSCE 25.08.22.py"

      - name: Localizar CSV y calcular hash
        id: csv
        run: |
          set -euo pipefail
          CSV_PATH="$(find . -type f -name 'eventos_agility_2025.csv' -print -quit)"
          if [ -z "$CSV_PATH" ]; then
            echo 'No se encontrÃ³ eventos_agility_2025.csv'; exit 1
          fi
          echo "csv_path=$CSV_PATH" >> "$GITHUB_OUTPUT"
          sha256sum "$CSV_PATH" | awk '{print $1}' > local.sha256

      - name: Comprobar curl
        run: curl --version

      - name: Preparar URL remota (FTPS explÃ­cito en 21)
        id: remote
        env:
          FTP_SERVER:     ${{ secrets.FTP_SERVER }}
          FTP_USERNAME:   ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD:   ${{ secrets.FTP_PASSWORD }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}   # p.ej.: /www/NewWeb/Privado
        run: |
          set -euo pipefail
          # Normaliza: quita barras sobrantes y URL-encode (sin codificar '/')
          ENC_DIR="$(python -c "import os,urllib.parse; p=os.environ.get('FTP_REMOTE_DIR','/'); p='/' + p.strip('/').rstrip('/'); print(urllib.parse.quote(p, safe='/'))")"
          BASE_PATH="${ENC_DIR}/Competiciones/EventosProx/RSCE/data"
          echo "base_path=${BASE_PATH}" >> "$GITHUB_OUTPUT"
          echo "remote_file=${BASE_PATH}/eventos_agility_2025.csv" >> "$GITHUB_OUTPUT"
          echo "ðŸ“ BASE_PATH=${BASE_PATH}"

      - name: Listar carpeta remota (antes de subir)
        env:
          FTP_SERVER:   ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail
          BASE_PATH="${{ steps.remote.outputs.base_path }}"
          curl --fail --ssl-reqd \
               --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
               --ftp-method nocwd --disable-epsv --ftp-skip-pasv-ip \
               "ftp://${FTP_SERVER}${BASE_PATH}/" -l || true

      - name: Subir CSV (estrategia mÃºltiple: FTPS explÃ­cito/activo e implÃ­cito 990)
        env:
          FTP_SERVER:   ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail
          CSV_PATH="${{ steps.csv.outputs.csv_path }}"
          REMOTE_FILE="${{ steps.remote.outputs.remote_file }};type=i"     # fuerza binario

          echo "Archivo local: ${CSV_PATH}"
          echo "Ruta remota (path): ${REMOTE_FILE}"

          # Intento 1: FTPS EXPLÃCITO (TLS en 21), PASV (por defecto), sin EPSV
          echo "Intento 1) FTPS explÃ­cito, PASV"
          if curl -v --fail --ssl-reqd \
               --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
               --ftp-method nocwd \
               --disable-epsv --ftp-skip-pasv-ip \
               --upload-file "${CSV_PATH}" \
               "ftp://${FTP_SERVER}${REMOTE_FILE}"; then
            echo "âœ… Subida OK (FTPS explÃ­cito PASV)"
          else
            rc=$?
            echo "âŒ Fallo intento 1 (rc=${rc})"
            echo "Intento 2) FTPS explÃ­cito, MODO ACTIVO"
            # Modo activo: el servidor abre conexiÃ³n de datos hacia runner
            if curl -v --fail --ssl-reqd \
                 --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
                 --ftp-method nocwd \
                 --ftp-port "-" \
                 --upload-file "${CSV_PATH}" \
                 "ftp://${FTP_SERVER}${REMOTE_FILE}"; then
              echo "âœ… Subida OK (FTPS explÃ­cito ACTIVO)"
            else
              rc=$?
              echo "âŒ Fallo intento 2 (rc=${rc})"
              echo "Intento 3) FTPS IMPLÃCITO (puerto 990), PASV"
              if curl -v --fail \
                   --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
                   --ftp-method nocwd \
                   --disable-epsv --ftp-skip-pasv-ip \
                   --upload-file "${CSV_PATH}" \
                   "ftps://${FTP_SERVER}:990${REMOTE_FILE}"; then
                echo "âœ… Subida OK (FTPS implÃ­cito 990)"
              else
                rc=$?
                echo "âŒ Fallo intento 3 (rc=${rc})"
                exit "${rc}"
              fi
            fi
          fi

      - name: Verificar remoto (descargar y comparar hash)
        env:
          FTP_SERVER:   ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail
          REMOTE_FILE="${{ steps.remote.outputs.remote_file }};type=i"

          echo "VerificaciÃ³n con FTPS explÃ­cito (21)â€¦"
          if curl --fail --ssl-reqd \
               --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
               --ftp-method nocwd \
               --disable-epsv --ftp-skip-pasv-ip \
               --output remote.csv \
               "ftp://${FTP_SERVER}${REMOTE_FILE}"; then
            :
          else
            echo "Descarga explÃ­cita fallÃ³, probamos FTPS implÃ­cito 990â€¦"
            curl --fail \
                 --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
                 --ftp-method nocwd \
                 --disable-epsv --ftp-skip-pasv-ip \
                 --output remote.csv \
                 "ftps://${FTP_SERVER}:990${REMOTE_FILE}"
          fi

          sha256sum remote.csv | awk '{print $1}' > remote.sha256
          diff -q local.sha256 remote.sha256
          echo "âœ… Hash OK"

