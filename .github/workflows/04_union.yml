name: 04 Union participantes

on:
  workflow_run:
    workflows: ["03 Participantes (scrape + process)"]  # <-- Debe coincidir EXACTAMENTE con el 'name' del 03
    types: [completed]

jobs:
  union:
    # Solo ejecuta si el run del 03 termin√≥ OK
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    env:
      OUT_DIR: ./output

    steps:
      - uses: actions/checkout@v4

      - name: Ensure output dir
        shell: bash
        run: mkdir -p "$OUT_DIR"

      - name: Log triggering run
        shell: bash
        run: |
          echo "Triggered by run: ${{ github.event.workflow_run.id }}"
          echo "From workflow  : ${{ github.event.workflow.name }}"
          echo "Conclusion      : ${{ github.event.workflow_run.conclusion }}"

      # üîΩ Descarga del run que nos dispar√≥ (la pieza clave)
      - name: Download artifacts from triggering 03 run
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          name: a03-participants-processed
          merge-multiple: true
          path: ${{ env.OUT_DIR }}

      - name: Fail if nothing downloaded
        shell: bash
        run: |
          set -euo pipefail
          if ! ls -1 "$OUT_DIR"/* 1>/dev/null 2>&1; then
            echo "::error::No se descarg√≥ ning√∫n artefacto del 03 (run ${GITHUB_EVENT_PATH})."
            exit 1
          fi

      - name: Debug listing
        shell: bash
        run: |
          echo "Contenido de $OUT_DIR:"
          ls -la "$OUT_DIR" || true
          echo "Ficheros:"
          find "$OUT_DIR" -maxdepth 1 -type f -printf "%f\n" || true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run union
        shell: bash
        run: |
          set -euo pipefail
          python ./04_eventosproxUnion.py "$OUT_DIR" "$OUT_DIR/participantes_completos_final.json"

      - name: Upload final artifact
        uses: actions/upload-artifact@v4
        with:
          name: a04-participantes-final
          path: ${{ env.OUT_DIR }}/participantes_completos_final.json
          if-no-files-found: error
